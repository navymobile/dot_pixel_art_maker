---
name: QR Payload Specification v3
id: SPEC_QR_PAYLOAD_V3
status: draft
version: 3.0
created_at: 2026-02-12
scope: qr_exchange
---

# QR Payload Specification v3

本仕様は、16×16ドット絵交換アプリにおける「対面QR交換」用のシリアライズ形式（Wire Format）を定義する。
目的は、端末間での交換において **データ構造の不可分性（作品＋系譜）** と **誤り検知（CRC32）** を担保し、実装の発散を防ぐこと。

## 1. 用語

| 用語        | 定義                                                      |
| ----------- | --------------------------------------------------------- |
| Wire Format | QRに載せるための文字列フォーマット                        |
| Payload     | Wire Format の末尾に格納される Base64URL 化対象のバイナリ |
| Pixel Data  | 16×16=256ピクセルの色データ（RGBA5551）                   |
| Lineage     | 出自を表す系譜ログ（16B×N）                               |
| CRC32       | 偶発的な読み取り誤りを検知するチェックサム（4B）          |

## 2. 仕様の前提（設計原則）

| 原則           | 要求                                                  |
| -------------- | ----------------------------------------------------- |
| サイズ固定     | 画像は必ず 16×16（256px）                             |
| 交換手段固定   | 交換は対面QRのみ（オンライン交換は扱わない）          |
| 出自が必ず残る | 作品データと系譜データは不可分（同一payload内に同梱） |
| 実装発散を防ぐ | エンコード/デコードは単一のCodecに集約                |
| 最小構成       | 不要なメタデータ、SNS的要素は含めない                 |

## 3. Wire Format（v3）

### 3.1 文字列フォーマット

以下の4要素を `|` で連結する。

`v3|<uuid>|<gen>|<base64url_payload>`

| フィールド        | 型     | 制約                          |
| ----------------- | ------ | ----------------------------- |
| version           | string | 固定値 `v3`                   |
| uuid              | string | UUID（8-4-4-4-12、16進）      |
| gen               | int    | 0以上の整数（10進表記）       |
| base64url_payload | string | Base64URL、**パディング無し** |

### 3.2 パース要件

| ルール   | 要求                                |
| -------- | ----------------------------------- | -------------------------------------- |
| 区切り数 | `split('                            | ')` した結果が **必ず4要素**であること |
| version  | `v3` 以外は reject                  |
| uuid     | 正規表現で厳格検証（8-4-4-4-12）    |
| gen      | `int.tryParse` に成功し、`gen >= 0` |
| payload  | Base64URLデコード可能であること     |

## 4. Payload（Binary Structure）

Payload は Base64URL エンコードされる前の生バイナリであり、以下の構造を持つ。

### 4.1 バイナリレイアウト

| オフセット | サイズ | 項目          | 内容                                |
| ---------: | -----: | ------------- | ----------------------------------- |
|          0 |   512B | Pixel Data    | RGBA5551（Big-endian）              |
|        512 |     1B | Lineage Count | N（0..Nmax）                        |
|        513 |  16B×N | Lineage Log   | 16Bエントリ×N（固定配置のバイト列） |
|    513+16N |     4B | CRC32         | Big-endian                          |

### 4.2 N の上限（Nmax）

本仕様では N の上限を Nmax として固定する（値は実装により決定するが仕様に明記する）。

| パラメータ | 型  |  例 | 意味                 |
| ---------- | --- | --: | -------------------- |
| Nmax       | int |  20 | 系譜ログの最大保持数 |

### 4.3 厳格な長さ検証

デコード時、payloadの総バイト長は以下に一致しなければならない。

`payload_len == 512 + 1 + 16*N + 4`

不一致の場合は `FormatException` とする。

## 5. Pixel Data（RGBA5551）

### 5.1 ピクセル数

| 項目              |  値 |
| ----------------- | --: |
| pixel_count       | 256 |
| bytes_per_pixel   |   2 |
| pixel_bytes_total | 512 |

### 5.2 RGBA5551 ビットレイアウト（16bit）

|    bit | 名称 | サイズ | 備考             |
| -----: | ---- | -----: | ---------------- |
| 15..11 | R    |      5 | 0..31            |
|  10..6 | G    |      5 | 0..31            |
|   5..1 | B    |      5 | 0..31            |
|      0 | A    |      1 | 0=透明, 1=不透明 |

### 5.3 変換規約（ARGB32 ⇄ RGBA5551）

| 方向              | 規約                                                                           |
| ----------------- | ------------------------------------------------------------------------------ |
| ARGB32 → RGBA5551 | `a==0` は 0x0000、それ以外は A=1 とし RGB を 8bit→5bit（>>3）で量子化          |
| RGBA5551 → ARGB32 | A=0なら 0x00000000、A=1なら alpha=0xFF、RGBは bit replication で 5bit→8bit復元 |

## 6. Lineage Log（16 bytes entry）

Lineage エントリは 16B固定のバイト列として定義する。
本仕様は「構造（16B固定）」のみを保証し、内部フォーマットは別仕様（Lineage Entry Spec）で定義する。

| 項目       | 要求                                           |
| ---------- | ---------------------------------------------- |
| entry_size | 16 bytes 固定                                  |
| endian     | バイト列固定（数値のendiannessを前提にしない） |
| count      | 4.1 の N に従う                                |

## 7. CRC32

### 7.1 目的

CRC32 は、QR読み取り時の偶発的な誤り（反射・手ブレ等）を検知するために使用する。

### 7.2 CRC計算対象

CRC32 は、payload末尾のCRC32領域を除いた以下の範囲で計算する。

`[0 .. (513 + 16*N - 1)]`

| 対象          | 含む         |
| ------------- | ------------ |
| Pixel Data    | 含む         |
| Lineage Count | 含む         |
| Lineage Log   | 含む         |
| CRC32自身     | **含まない** |

### 7.3 格納

| 項目           | 要求                              |
| -------------- | --------------------------------- |
| stored_crc32   | 4B Big-endian                     |
| computed_crc32 | 同一アルゴリズムで算出            |
| mismatch       | `FormatException('CRC mismatch')` |

## 8. エンコード/デコード要件（エラー方針）

| ケース        | 動作                     |
| ------------- | ------------------------ |
| version不一致 | reject（nullまたは例外） |
| uuid不正      | reject                   |
| gen不正       | reject                   |
| base64不正    | `FormatException`        |
| 長さ不一致    | `FormatException`        |
| CRC不一致     | `FormatException`        |

## 9. 参考（v2との違い）

| 項目               | v2                   | v3                     |
| ------------------ | -------------------- | ---------------------- | --- | ----------- | --- | ---- | --- | ------------ |
| 文字列フォーマット | `v2                  | id                     | gen | pixels_b64` | `v3 | uuid | gen | payload_b64` |
| payload            | pixelsのみ           | pixels + lineage + crc |
| 誤り検知           | なし（長さ検証のみ） | CRC32あり              |
| 不可分性           | 画像のみ             | 作品＋系譜が不可分     |
