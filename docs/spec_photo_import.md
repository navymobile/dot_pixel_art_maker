# 写真取込・ドット絵生成仕様 (Photo Import & Dot Generation)

**概要**:
カメラ撮影または写真ライブラリから画像を取り込み、16×16ピクセルの「下絵（Draft）」としてキャンバスに適用する機能の仕様。
生成はあくまで編集の補助機能であり、作品としての完成や保存はユーザーの明示的な操作に委ねる。

---

## 1. 基本方針 (Core Principles)

| 項目             | 方針                                                                                                                   |
| :--------------- | :--------------------------------------------------------------------------------------------------------------------- |
| **目的**         | 絵心の有無に関わらず、ドット絵作成の「アタリ（下絵）」を提供し、編集のハードルを下げる。                               |
| **データ保持**   | **元画像（写真）はアプリ内に一切保存しない**。DB、ファイル、サムネイル、履歴のいずれにも残さない。**ログ出力も禁止**。 |
| **作品性**       | 生成結果をそのまま「作品」とはせず、キャンバスへの適用（Apply）までを責務とする。保存はユーザー任せ。                  |
| **クロップ**     | - ユーザーは画像の切り抜きを行う。                                                                                     |
|                  | - **アスペクト比は 1:1（正方形）に固定する。** 他の比率は選択不可とする。                                              |
| **フォーマット** | 生成出力は **ARGB32 (A=255固定)**。**v3 (RGBA5551) 準拠は保存/交換時のみ**とする（手描き編集と同等の扱い）。           |

---

## 2. 要件定義 (Requirements)

### 2.1 機能要件

1.  **画像取得**: カメラ撮影、または写真ライブラリからの選択（**1枚のみ**）。
2.  **クロップ**: 取り込み時に **1:1（正方形）** へのトリミングを強制する。
    - `aspectRatioPresets: [square]` のみに限定。
    - Android: `lockAspectRatio: true` を設定。
3.  **生成調整**: 以下のパラメータを調整してドット絵（16×16）を生成できること。
    - **Filter**: `Smooth`（滑らか） / `Crisp`（くっきり）
    - **Brightness**: 明るさ調整 (-20 ~ +20)
    - **Contrast**: コントラスト調整 (-20 ~ +20)
4.  **適用 (Apply)**: 生成結果でキャンバス全体を上書きする。
5.  **Undo**: **Apply直前のキャンバス状態を1世代保持する専用Undo** を提供する。

### 2.2 非機能要件

- **プライバシー**:
  - 撮影した写真は端末のカメラロールには保存され得るが、アプリ固有領域には保存しない。
  - **一時ファイル（path/bytes）は生成完了後に即座に参照を破棄する**。
- **パフォーマンス**:
  - 画像処理（Decode/Resize）は重くなる可能性があるため、**非同期 (Future/Isolate)** 前提のI/Fとする。
- **色の一貫性**:
  - 「写真からは透明を生成しない」(A=255固定)。
  - 透明判定は ARGB32 の `a == 0` のみとし、黒 `a == 255` と混同しないこと。

---

## 3. UIフロー & 操作 (User Interface)

1.  **起動**: ツールバーの「📷 (Camera)」アイコンをタップ。
2.  **ソース選択**: 「カメラで撮影」か「ライブラリから選択」を選ぶ。
3.  **クロップ (Crop)**:
    - `image_cropper` UIが起動。
    - **アスペクト比は 1:1 固定 (Lock)**。プリセットは Square のみ。
    - トリミング範囲を決定して完了。
4.  **生成設定 (Generation Settings)**:
    - プレビュー（16×16に拡大表示）を見ながらパラメータをスライダー等で調整。
    - 「適用 (Apply)」ボタンで確定。
5.  **キャンバス反映**:
    - エディタに戻り、キャンバスが生成画像で上書きされる。
    - **Undoボタン**（またはスナックバーのUndoアクション）で直前の状態に戻せる。
    - 以降はペン/消しゴムで通常通り編集可能。

---

## 4. 技術仕様 (Technical Specs)

### 4.1 使用ライブラリ

- `image_picker`: 画像選択・撮影
- `image_cropper`: 画像トリミング (1:1固定設定)
- `image`: 画像リサイズ・ピクセル操作

### 4.2 データ処理パイプライン

1.  **Decode**: クロップされた画像ファイル (`Uint8List`) を `image` パッケージでデコード (RGBA)。
2.  **Resize**: 16×16サイズに縮小。補間アルゴリズムは `Filter` 設定 (`linear` vs `nearest`) で切り替え。
3.  **Tone Adjust**: 16×16の各ピクセルに対し、Brightness/Contrast の線形変換を適用。
    - `x' = clamp(((x - 128) * c + 128) + 255*b, 0, 255)`
4.  **Output**: `List<int>` (長さ256, ARGB形式, Alpha=255固定) を生成。

### 4.3 データ構造

- **入力 (Input)**:
  - `sourceBytes`: `Uint8List` (クロップ済み画像)
  - `params`: `{ filter: Enum, brightness: int, contrast: int }`
- **出力 (Output)**:
  - `Future<List<int>>`: 非同期で返す 256px ARGB32 配列

### 4.4 永続化・保存

- **生成機能自体は保存を行わない**。
- キャンバスに適用された時点で、データはメモリ上の `DotModel` (pixels) となる。
- ユーザーがエディタの「保存」ボタンを押した時のみ、通常のフロー（Hive / v3形式）で保存される。

---

## 5. 実装フェーズ (Implementation Plan)

1.  **Package導入**: `pubspec.yaml` への追加とネイティブ設定 (Info.plist等)。
2.  **Logic実装**: `PhotoDotDraftUsecase` クラスの作成（画像処理ロジック）。
3.  **UI実装**:
    - `ImportPhotoSheet` (設定モーダル) の作成。
    - `DotEditor` との結合、Undoの実装。
4.  **検証**:
    - 実機でのカメラ/ライブラリ動作。
    - 生成画質とUndo動作の確認。
