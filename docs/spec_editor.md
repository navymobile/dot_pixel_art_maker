# エディタ仕様 (Editor Specifications)

現在の `DotEditor` および `EditScreen` の仕様・機能一覧です。

---

## 1. キャンバス (Canvas)

**概要**
`AppConfig.dots` × `AppConfig.dots` のピクセルアートを描画するメイン領域です。

**仕様**

- **解像度**: `AppConfig.dots` × `AppConfig.dots` ピクセル（現在 21×21）
- **背景**: 透明色を表現するために `Colors.grey.shade100` で塗りつぶし
- **中心ガイド**: 11行目（`y = 10`）と11列目（`x = 10`）のセル背景を `Colors.grey.shade200` で描画し、十字のガイドラインを表示
- **グリッド線**: セル間の仕切り線のみ表示（外周のボーダーは描画しない）。ドットの上に描画されるため、塗りつぶし後もグリッドが常に見える
  - 縦線: `i = 1` 〜 `dots - 1` のみ描画（左端・右端なし）
  - 横線: `i = 1` 〜 `dots - 1` のみ描画（上端・下端なし）
- **外周ボーダー**: キャンバスの表示領域全体を `Colors.grey.shade700` の枠線で囲む
- **描画順序**: 背景 → 中心ガイド → ドット → プレビュー → グリッド線 → 外枠
- **アスペクト比**: 1:1 固定で画面幅に合わせて最大表示
- **初期化**: `initialDot.pixels.length` が `dots*dots` と不一致の場合、全透明で初期化（次元変更時の安全策）

### ジェスチャー操作

| 指の数 | 操作        | 動作                                                  |
| :----- | :---------- | :---------------------------------------------------- |
| 1本指  | タップ      | 選択中ツール（ペン/消しゴム/スポイト/バケツ）を実行   |
| 1本指  | ドラッグ    | 連続描画（ペン/消しゴム）、円プレビュー（円周ツール） |
| 2本指  | ピンチ      | キャンバスの拡大・縮小（1.0x 〜 5.0x）                |
| 2本指  | ピンチ+移動 | フォーカル移動により拡大時のパンも可能                |

**実装方針**:

- `InteractiveViewer(panEnabled: false)` で1本指パンを無効化
- 内側に `Listener`（raw pointer）を配置し、アクティブポインター数で描画 vs 拡大を判別
- 2本指検出時に `_isScaling = true` で描画をキャンセル
- 2本指モード終了後、次の `onPointerDown` まで描画開始しないガード (`_wasScaling`) を設置
- **タッチ遅延ガード**: `PointerDown` 時に即座に描画せず、50ms のタイマーで遅延させる。50ms 以内に2本目の指が来た場合はタイマーをキャンセルし描画しない。これにより、ピンチ操作開始時にドットが1つ誤描画される問題を防止する

**境界制約**:

- `boundaryMargin: EdgeInsets.zero` — キャンバスの端が表示領域の端を超えてスクロールできない
- 等倍時はパン不可、拡大時はキャンバスの端まで移動可能

**ズーム基準点**:

- ピンチの中間点（フォーカルポイント）を基準に拡大する
- 例: 右上をピンチ → 右上が固定され左下方向に拡大

### 描画補間（書き心地）

ドラッグ操作で高速に指を動かした際にドットが歯抜けにならないよう、**Bresenham's Line Algorithm** による補間を行っています。

- **仕組み**: 前回描画したセル (`_lastDrawnPoint`) と現在のセルの間の全セルを直線的に補間して塗りつぶす
- **対象ツール**: ペン、消しゴム（どちらも同じ補間ロジックを使用）
- **リセット**: `PointerUp` 時に `_lastDrawnPoint` をクリアし、次のストロークに影響しない
- **効果**: 高速なドラッグでもドットが途切れず、なめらかな書き心地を実現

---

## 2. ツールバー (Toolbar)

**概要**
描画に必要なツールを切り替える操作エリアです。キャンバスの下に配置されています。

**機能一覧**

| アイコン | 名称 (Name)               | 説明                                                                                                                                               |
| :------- | :------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------- |
| 💾       | **保存 (Save)**           | 現在のキャンバスの状態を保存します。保存完了時に「Saved!」と通知を表示します。                                                                     |
| 📷       | **読込 (Import)**         | カメラや写真ライブラリから画像を取り込み、1:1 クロップ後にドット絵に変換します。Undo が 1 世代分保持されます。                                     |
| 🔍       | **スポイト (Eyedropper)** | タップするとスポイトモードになり、キャンバス上のタップした箇所のピクセル色を抽出してペン色に設定します。色を抽出すると自動でペンモードに戻ります。 |
| 🔵       | **ペン (Pen)**            | 色を塗るモードに切り替えます。アイコンの色は現在選択中の色を反映します。<br>既にペンモードの場合、タップすると **カラーピッカー** が開きます。     |
| 🎨       | **バケツ (Fill)**         | タップしたピクセルと同じ色の連続領域を、現在選択中の色で塗りつぶします（BFS による Flood Fill）。                                                  |
| ⭕       | **円周 (Circle)**         | ドラッグ開始点と終了点を対角とする矩形に内接する楕円の「枠線」を描画します（中抜き）。ドラッグ中はプレビュー表示。                                 |
| 🧹       | **消しゴム (Eraser)**     | 色を消す（透明 `0x00000000` にする）モードに切り替えます。                                                                                         |
| 🗑️       | **全消去 (Clear)**        | キャンバスをすべてリセット（透明）にします。自動保存は行いません。                                                                                 |

---

## 3. カラーピッカー (Color Picker)

**概要**
任意の色を選択するためのダイアログです。

**仕様**

- **起動**: ペンツール選択中に再度ペンアイコンをタップで表示
- **形式**: リング型ピッカー (HueRingPicker)
- **色空間**: RGB (不透明)。透明度 (Alpha) は選択不可。
- **量子化プレビュー**: `AppConfig.pixelEncoding` に応じて選択色を即座に量子化
  - `rgb444`: RGB444 (4096色) に量子化
  - `indexed8`: RGB332 (256色) に量子化
  - `rgba5551`: 量子化なし（フルカラー）

---

## 4. パレット (Palette)

**概要**
よく使う色や履歴へ素早くアクセスするためのエリアです。ツールバーの下に配置されています。

**構成**

### A. グレースケール (Grayscale)

- **内容**: 白〜黒のモノトーン 8色
- **仕様**: 固定表示。変更不可。

### B. 履歴 (Recent Colors)

- **内容**: 最近使用した色 (最大32色)
- **仕様**:
  - **追加タイミング**: キャンバスに実際に色を塗った (Draw) 時、またはドラッグ終了時に追加される。
  - **更新ルール**: 新しい色が先頭に追加され、重複は移動、32色を超えると古い順に消える (LRU方式)。
  - **保存**: アプリ全体で共有・永続化される（Hive ストレージを使用）。

---

## 5. 画像インポート (Photo Import)

**概要**
カメラまたは写真ライブラリから画像を取り込み、ドット絵に変換する機能です。

**フロー**

1. **ソース選択**: BottomSheet でカメラ / フォトライブラリを選択
2. **画像取得**: `ImagePicker` で画像を取得
3. **クロップ**: `ImageCropper` で 1:1 正方形にクロップ（アスペクト比固定）
4. **変換**: `ImportPhotoSheet` でドット絵に変換、プレビュー表示
5. **適用**: 変換結果をキャンバスに反映。適用前のピクセルは Undo バッファに保存。
6. **量子化**: `AppConfig.pixelEncoding` に応じて変換後のピクセルも量子化される。

**Undo**: インポート直後に1世代分の取り消しが可能（`_undoPixels`）。次のインポートで上書きされる。

---

## 6. 画面構成 (Edit Screen)

**概要**
エディタ全体を包む画面です。

**仕様**

- **ヘッダー (AppBar)**: タイトル「Editor」と、現在の世代数「Gen: X」を表示します。
- **レイアウト**:
  - 上部: キャンバス (Expanded)
  - 中部: ツールバー
  - 下部: パレット
- **保存挙動**: 自動保存は行わず、ユーザーが明示的に保存ボタンを押した時のみ保存処理を実行します。
